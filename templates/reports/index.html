{% extends "base.html" %}
{% block page_title %}Reports{% endblock %}
{% block page_subtitle %}Custom reports, exports, and analytics (tenant scoped){% endblock %}
{% block content %}

<style>
  .section{margin-bottom:14px;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
  .panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px;box-shadow:0 12px 34px rgba(0,0,0,.22);}

  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);text-decoration:none;white-space:nowrap;background:transparent;cursor:pointer;}
  .btn.primary{border-color:rgba(37,214,255,.35);background:rgba(37,214,255,.06);}
  .btn.ghost{opacity:.90;}
  .muted{opacity:.70;font-size:13px;line-height:1.35;}

  /* Dropdown */
  .dd{position:relative;display:inline-flex;}
  .dd > summary{
    list-style:none;
    user-select:none;
  }
  .dd > summary::-webkit-details-marker{display:none;}
  .menu{
    position:absolute;
    right:0;
    top:calc(100% + 8px);
    min-width:240px;
    z-index:50;
    background:rgba(10,10,18,.98);
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    box-shadow:0 20px 50px rgba(0,0,0,.45);
    overflow:hidden;
  }
  body.light .menu{
    background:rgba(255,255,255,.98);
  }
  .menu a{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    text-decoration:none;
    border-bottom:1px solid rgba(255,255,255,.08);
    font-weight:700;
  }
  .menu a:last-child{border-bottom:none;}
  .menu a:hover{background:rgba(37,214,255,.07);}
  .tag{font-size:11px;opacity:.70;border:1px solid rgba(255,255,255,.14);padding:2px 8px;border-radius:999px;}

  /* KPIs */
  .grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:12px;align-items:stretch;}
  .card{
    grid-column:span 4;
    background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;
    padding:14px;
    box-shadow:0 12px 34px rgba(0,0,0,.22);
    display:flex;
    flex-direction:column;
    gap:8px;
    text-decoration:none;
    min-height:132px;
    justify-content:space-between;
  }
  .k{font-size:12px;letter-spacing:.08em;text-transform:uppercase;opacity:.70;}
  .v{font-size:28px;font-weight:950;line-height:1;}
  .warn{border-color:rgba(255,200,60,.35);background:rgba(255,200,60,.08);}
  .danger{border-color:rgba(255,80,80,.35);background:rgba(255,80,80,.08);}
  .info{border-color:rgba(37,214,255,.30);background:rgba(37,214,255,.06);}

  /* Charts fixed height */
  .charts{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:12px;align-items:stretch;}
  .chartbox{grid-column:span 6;}
  .chartbox.wide{grid-column:span 12;}
  .chart-title{font-weight:950;margin-bottom:10px;}
  .chart-wrap{position:relative;height:320px;width:100%;overflow:hidden;}
  .chart-wrap.tall{height:360px;}
  .chart-wrap canvas{position:absolute;inset:0;width:100% !important;height:100% !important;display:block;}

  @media (max-width: 1100px){
    .card{grid-column:span 6;}
    .chartbox{grid-column:span 12;}
  }
  @media (max-width: 700px){
    .card{grid-column:span 12;}
    .menu{min-width:220px;}
  }
</style>

<div class="section panel">
  <div class="row">
    <div>
      <div style="font-weight:950;font-size:18px;">Reports Center</div>
      <div class="muted">Run weekly/monthly reports, export data, or print a snapshot. Everything is tenant-scoped.</div>
    </div>

    <div class="row reports-toolbar" style="justify-content:flex-end;">
      <!-- Custom Reports -->
      <details class="dd">
        <summary class="btn primary">Custom Reports ▾</summary>
        <div class="menu">
          <a href="{% url 'reports:weekly_report' %}">
            Weekly Operations <span class="tag">Charts</span>
          </a>
          <a href="{% url 'reports:monthly_report' %}">
            Monthly Executive <span class="tag">Charts</span>
          </a>
          <a href="{% url 'reports:print_report' %}" target="_blank">
            Print Snapshot <span class="tag">PDF</span>
          </a>
        </div>
      </details>

      <!-- CSV Exports -->
      <details class="dd">
        <summary class="btn ghost">Export CSV ▾</summary>
        <div class="menu">
          <a href="{% url 'reports:export_fuel_csv' %}">Fuel Logs <span class="tag">CSV</span></a>
          <a href="{% url 'reports:export_inspections_csv' %}">Inspections <span class="tag">CSV</span></a>
          <a href="{% url 'reports:export_inspection_alerts_csv' %}">Inspection Alerts <span class="tag">CSV</span></a>
          <a href="{% url 'reports:export_documents_csv' %}">Documents <span class="tag">CSV</span></a>
        </div>
      </details>

      <!-- Excel Exports -->
      <details class="dd">
        <summary class="btn ghost">Export Excel ▾</summary>
        <div class="menu">
          <a href="{% url 'reports:export_fuel_xlsx' %}">Fuel Logs <span class="tag">XLSX</span></a>
          <a href="{% url 'reports:export_inspections_xlsx' %}">Inspections <span class="tag">XLSX</span></a>
          <a href="{% url 'reports:export_inspection_alerts_xlsx' %}">Inspection Alerts <span class="tag">XLSX</span></a>
          <a href="{% url 'reports:export_documents_xlsx' %}">Documents <span class="tag">XLSX</span></a>
        </div>
      </details>
    </div>
  </div>
</div>

<div class="section">
  <div class="grid">
    <a class="card info" href="{% url 'fleet:vehicle_list' %}">
      <div>
        <div class="k">Vehicles</div>
        <div class="v">{{ vehicle_count }}</div>
      </div>
      <div class="muted">Total vehicles for this tenant.</div>
    </a>

    <a class="card warn" href="{% url 'inspections:alerts' %}">
      <div>
        <div class="k">Open Inspection Alerts</div>
        <div class="v">{{ open_alerts }}</div>
      </div>
      <div class="muted">Active inspection issues that need attention.</div>
    </a>

    <a class="card danger" href="{% url 'inspections:list' %}?overdue=1">
      <div>
        <div class="k">Overdue Inspections</div>
        <div class="v">{{ overdue_inspections }}</div>
      </div>
      <div class="muted">Past due date and not completed.</div>
    </a>

    <a class="card info" href="{% url 'inspections:list' %}?due_soon=1">
      <div>
        <div class="k">Due Soon (7 days)</div>
        <div class="v">{{ due_soon_inspections }}</div>
      </div>
      <div class="muted">Upcoming inspections that should be scheduled.</div>
    </a>

    <a class="card danger" href="{% url 'documents:document_list' %}?expired=1">
      <div>
        <div class="k">Expired Documents</div>
        <div class="v">{{ expired_docs }}</div>
      </div>
      <div class="muted">Docs past expiration date.</div>
    </a>

    <a class="card warn" href="{% url 'documents:document_list' %}?expiring=1">
      <div>
        <div class="k">Expiring Documents (30 days)</div>
        <div class="v">{{ expiring_docs }}</div>
      </div>
      <div class="muted">Docs expiring soon.</div>
    </a>

    <a class="card warn" href="{% url 'fuel:alerts' %}">
      <div>
        <div class="k">Fuel: Missing / Stale Logs (30 days)</div>
        <div class="v">{{ fuel_stale_count }}</div>
      </div>
      <div class="muted">Vehicles with no recent fuel logs.</div>
    </a>

    <a class="card danger" href="{% url 'fuel:alerts' %}">
      <div>
        <div class="k">Fuel: Odometer Issues</div>
        <div class="v">{{ fuel_odo_alert_count }}</div>
      </div>
      <div class="muted">Possible data entry errors detected.</div>
    </a>

    <a class="card info" href="{% url 'fuel:list' %}">
      <div>
        <div class="k">Fuel Spend (30 days)</div>
        <div class="v">${{ spend_30|floatformat:2 }}</div>
      </div>
      <div class="muted">Total cost of fuel logs in last 30 days.</div>
    </a>
  </div>
</div>

<div class="section">
  <div class="charts">
    <div class="chartbox panel">
      <div class="chart-title">Fuel Spend — Daily (Last 30 Days)</div>
      <div class="chart-wrap">
        <canvas id="chartDaily"></canvas>
      </div>
    </div>

    <div class="chartbox panel">
      <div class="chart-title">Fuel Spend — Monthly (Last 12 Months)</div>
      <div class="chart-wrap">
        <canvas id="chartMonthly"></canvas>
      </div>
    </div>

    <div class="chartbox wide panel">
      <div class="chart-title">Top Vehicles by Fuel Spend (Last 90 Days)</div>
      <div class="chart-wrap tall">
        <canvas id="chartTop"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- JSON data blocks (valid HTML, keeps JS lint clean) -->
<script id="daily-labels" type="application/json">{{ daily_labels_json|safe }}</script>
<script id="daily-values" type="application/json">{{ daily_values_json|safe }}</script>

<script id="monthly-labels" type="application/json">{{ monthly_labels_json|safe }}</script>
<script id="monthly-values" type="application/json">{{ monthly_values_json|safe }}</script>

<script id="top-labels" type="application/json">{{ top_labels_json|safe }}</script>
<script id="top-values" type="application/json">{{ top_values_json|safe }}</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // ---------- helpers ----------
    const readJson = (id) => {
      const el = document.getElementById(id);
      if (!el) return null;
      try { return JSON.parse(el.textContent || "null"); } catch (e) { return null; }
    };

    const baseOptions = {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
    };

    // ---------- charts ----------
    const dailyEl = document.getElementById("chartDaily");
    const monthlyEl = document.getElementById("chartMonthly");
    const topEl = document.getElementById("chartTop");

    if (dailyEl) {
      const dailyLabels = readJson("daily-labels") || [];
      const dailyValues = readJson("daily-values") || [];
      new Chart(dailyEl, {
        type: "line",
        data: { labels: dailyLabels, datasets: [{ label: "Spend ($)", data: dailyValues, tension: 0.25 }] },
        options: baseOptions
      });
    }

    if (monthlyEl) {
      const monthlyLabels = readJson("monthly-labels") || [];
      const monthlyValues = readJson("monthly-values") || [];
      new Chart(monthlyEl, {
        type: "bar",
        data: { labels: monthlyLabels, datasets: [{ label: "Spend ($)", data: monthlyValues }] },
        options: baseOptions
      });
    }

    if (topEl) {
      const topLabels = readJson("top-labels") || [];
      const topValues = readJson("top-values") || [];
      new Chart(topEl, {
        type: "bar",
        data: { labels: topLabels, datasets: [{ label: "Spend ($)", data: topValues }] },
        options: { ...baseOptions, indexAxis: "y" }
      });
    }

    // ---------- dropdown hover behavior ----------
    const dds = document.querySelectorAll(".dd");
    if (!dds.length) return;

    dds.forEach(dd => {
      dd.addEventListener("mouseenter", () => {
        document.querySelectorAll(".dd[open]").forEach(openDd => {
          if (openDd !== dd) openDd.removeAttribute("open");
        });
        dd.setAttribute("open", true);
      });

      dd.addEventListener("mouseleave", () => {
        dd.removeAttribute("open");
      });
    });
  });
</script>

{% endblock %}

