{% extends "base.html" %}
{% block page_title %}Reports{% endblock %}
{% block page_subtitle %}Exports + charts (tenant scoped){% endblock %}
{% block content %}

<style>
  .section{margin-bottom:14px;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);text-decoration:none;white-space:nowrap;background:transparent;}
  .btn.primary{border-color:rgba(37,214,255,.35);background:rgba(37,214,255,.06);}
  .panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px;box-shadow:0 12px 34px rgba(0,0,0,.22);}

  .grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:12px;align-items:stretch;}
  .card{
    grid-column:span 4;
    background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;
    padding:14px;
    box-shadow:0 12px 34px rgba(0,0,0,.22);
    display:flex;
    flex-direction:column;
    gap:8px;
    text-decoration:none;
    min-height:132px;
    justify-content:space-between;
  }
  .k{font-size:12px;letter-spacing:.08em;text-transform:uppercase;opacity:.70;}
  .v{font-size:28px;font-weight:950;line-height:1;}
  .muted{opacity:.70;font-size:13px;line-height:1.35;}
  .warn{border-color:rgba(255,200,60,.35);background:rgba(255,200,60,.08);}
  .danger{border-color:rgba(255,80,80,.35);background:rgba(255,80,80,.08);}
  .info{border-color:rgba(37,214,255,.30);background:rgba(37,214,255,.06);}

  /* Charts: IMPORTANT — fixed wrapper height to prevent "runaway expansion" */
  .charts{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:12px;align-items:stretch;}
  .chartbox{grid-column:span 6;}
  .chartbox.wide{grid-column:span 12;}
  .chart-title{font-weight:950;margin-bottom:10px;}
  .chart-wrap{
    position:relative;
    height:320px;            /* hard stop */
    width:100%;
    overflow:hidden;         /* prevents any weird stretching */
  }
  .chart-wrap.tall{height:360px;}
  .chart-wrap canvas{
    position:absolute;
    inset:0;
    width:100% !important;
    height:100% !important;
    display:block;
  }

  @media (max-width: 1100px){
    .card{grid-column:span 6;}
    .chartbox{grid-column:span 12;}
  }
  @media (max-width: 700px){
    .card{grid-column:span 12;}
  }
</style>

<div class="section panel">
  <div class="row">
    <div>
      <div style="font-weight:950;font-size:18px;">Exports (CSV)</div>
      <div class="muted">Download tenant-scoped data for analysis.</div>
    </div>
    <div class="row" style="justify-content:flex-end;">
      <a class="btn primary" href="{% url 'reports:export_fuel_csv' %}">Download Fuel CSV</a>
      <a class="btn" href="{% url 'reports:export_inspections_csv' %}">Download Inspections CSV</a>
      <a class="btn" href="{% url 'reports:export_inspection_alerts_csv' %}">Download Alerts CSV</a>
      <a class="btn" href="{% url 'reports:export_documents_csv' %}">Download Documents CSV</a>
    </div>
  </div>
</div>

<div class="section">
  <div class="grid">

    <a class="card info" href="{% url 'fleet:vehicle_list' %}">
      <div>
        <div class="k">Vehicles</div>
        <div class="v">{{ vehicle_count }}</div>
      </div>
      <div class="muted">Total vehicles for this tenant.</div>
    </a>

    <a class="card warn" href="{% url 'inspections:alerts' %}">
      <div>
        <div class="k">Open Inspection Alerts</div>
        <div class="v">{{ open_alerts }}</div>
      </div>
      <div class="muted">Active inspection issues that need attention.</div>
    </a>

    <a class="card danger" href="{% url 'inspections:list' %}?overdue=1">
      <div>
        <div class="k">Overdue Inspections</div>
        <div class="v">{{ overdue_inspections }}</div>
      </div>
      <div class="muted">Past due date and not completed.</div>
    </a>

    <a class="card info" href="{% url 'inspections:list' %}?due_soon=1">
      <div>
        <div class="k">Due Soon (7 days)</div>
        <div class="v">{{ due_soon_inspections }}</div>
      </div>
      <div class="muted">Upcoming inspections that should be scheduled.</div>
    </a>

    <a class="card danger" href="{% url 'documents:document_list' %}?expired=1">
      <div>
        <div class="k">Expired Documents</div>
        <div class="v">{{ expired_docs }}</div>
      </div>
      <div class="muted">Docs past expiration date.</div>
    </a>

    <a class="card warn" href="{% url 'documents:document_list' %}?expiring=1">
      <div>
        <div class="k">Expiring Documents (30 days)</div>
        <div class="v">{{ expiring_docs }}</div>
      </div>
      <div class="muted">Docs expiring soon.</div>
    </a>

    <a class="card warn" href="{% url 'fuel:alerts' %}">
      <div>
        <div class="k">Fuel: Missing / Stale Logs (30 days)</div>
        <div class="v">{{ fuel_stale_count }}</div>
      </div>
      <div class="muted">Vehicles with no recent fuel logs.</div>
    </a>

    <a class="card danger" href="{% url 'fuel:alerts' %}">
      <div>
        <div class="k">Fuel: Odometer Issues</div>
        <div class="v">{{ fuel_odo_alert_count }}</div>
      </div>
      <div class="muted">Possible data entry errors detected.</div>
    </a>

    <a class="card info" href="{% url 'fuel:list' %}">
      <div>
        <div class="k">Fuel Spend (30 days)</div>
        <div class="v">${{ spend_30|floatformat:2 }}</div>
      </div>
      <div class="muted">Total cost of fuel logs in last 30 days.</div>
    </a>

  </div>
</div>

<div class="section">
  <div class="charts">
    <div class="chartbox panel">
      <div class="chart-title">Fuel Spend — Daily (Last 30 Days)</div>
      <div class="chart-wrap">
        <canvas id="chartDaily"></canvas>
      </div>
    </div>

    <div class="chartbox panel">
      <div class="chart-title">Fuel Spend — Monthly (Last 12 Months)</div>
      <div class="chart-wrap">
        <canvas id="chartMonthly"></canvas>
      </div>
    </div>

    <div class="chartbox wide panel">
      <div class="chart-title">Top Vehicles by Fuel Spend (Last 90 Days)</div>
      <div class="chart-wrap tall">
        <canvas id="chartTop"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const dailyLabels = {{ daily_labels_json|safe }};
  const dailyValues = {{ daily_values_json|safe }};

  const monthlyLabels = {{ monthly_labels_json|safe }};
  const monthlyValues = {{ monthly_values_json|safe }};

  const topLabels = {{ top_labels_json|safe }};
  const topValues = {{ top_values_json|safe }};

  const baseOptions = {
    responsive: true,
    maintainAspectRatio: false,
    animation: false,          // avoids resize jitter on some setups
  };

  new Chart(document.getElementById("chartDaily"), {
    type: "line",
    data: { labels: dailyLabels, datasets: [{ label: "Spend ($)", data: dailyValues, tension: 0.25 }] },
    options: baseOptions
  });

  new Chart(document.getElementById("chartMonthly"), {
    type: "bar",
    data: { labels: monthlyLabels, datasets: [{ label: "Spend ($)", data: monthlyValues }] },
    options: baseOptions
  });

  new Chart(document.getElementById("chartTop"), {
    type: "bar",
    data: { labels: topLabels, datasets: [{ label: "Spend ($)", data: topValues }] },
    options: { ...baseOptions, indexAxis: "y" }
  });
</script>

{% endblock %}
