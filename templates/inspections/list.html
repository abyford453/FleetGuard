{% extends "base.html" %}
{% block page_title %}Inspections{% endblock %}
{% block page_subtitle %}Assign, track, and complete vehicle inspections{% endblock %}
{% block content %}

<style>
  .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px;}
  .searchbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .searchbar input,.searchbar select{min-width:190px;}
  .panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px;box-shadow:0 12px 34px rgba(0,0,0,.25);}
  table{width:100%;border-collapse:collapse;}
  th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top;}
  th{font-size:12px;letter-spacing:.08em;text-transform:uppercase;opacity:.75;}
  .muted{opacity:.70;}
  .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);text-decoration:none;white-space:nowrap;}
  .btn.primary{border-color:rgba(37,214,255,.35);}
  .btn.warn{border-color:rgba(255,200,60,.35);}
  .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:12px;font-weight:750;}
  .pill.danger{border-color:rgba(255,80,80,.35);}

  /* "Check engine" / alert dot */
  .alert-icon{
    display:inline-flex;align-items:center;justify-content:center;
    width:22px;height:22px;border-radius:999px;
    border:1px solid rgba(255,200,60,.45);
    background:rgba(255,200,60,.12);
    box-shadow:0 8px 20px rgba(0,0,0,.20);
    text-decoration:none;
    position:relative;
  }
  .alert-icon::before{
    content:"!";
    font-weight:950;
    font-size:14px;
    line-height:1;
    opacity:.95;
  }
  .alert-icon:hover{transform:translateY(-1px);}
  .alert-banner{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:12px 14px;border-radius:16px;
    border:1px solid rgba(255,200,60,.35);
    background:rgba(255,200,60,.10);
    margin-bottom:12px;
  }
</style>

{% if open_alerts_count and open_alerts_count > 0 %}
  <div class="alert-banner">
    <div>
      <strong>Alerts:</strong> You have <strong>{{ open_alerts_count }}</strong> open inspection alert{{ open_alerts_count|pluralize }}.
      <span class="muted">Some vehicles may need attention.</span>
    </div>
    <a class="btn warn" href="{% url 'inspections:alerts' %}">View Alerts</a>
  </div>
{% endif %}

<div class="toolbar">
  <form class="searchbar" method="get">
    <input type="text" name="q" value="{{ q }}" placeholder="Search (type, notes, unit, make/model, plate/vin)">

    <select name="vehicle">
      <option value="">All Vehicles</option>
      {% for v in vehicles %}
        <option value="{{ v.id }}" {% if vehicle_id|stringformat:"s" == v.id|stringformat:"s" %}selected{% endif %}>
          {% if v.unit_number %}Unit {{ v.unit_number }} — {% endif %}{% if v.year %}{{ v.year }} {% endif %}{{ v.make }} {{ v.model }}
        </option>
      {% endfor %}
    </select>

    <select name="status">
      <option value="">All Status</option>
      {% for key,label in status_choices %}
        <option value="{{ key }}" {% if status == key %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>

    <select name="result">
      <option value="">All Results</option>
      {% for key,label in result_choices %}
        <option value="{{ key }}" {% if result == key %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>

    <label style="display:inline-flex;align-items:center;gap:8px;opacity:.9;">
      <input type="checkbox" name="my" value="1" {% if my == "1" %}checked{% endif %}>
      My Inspections
    </label>

    <label style="display:inline-flex;align-items:center;gap:8px;opacity:.9;">
      <input type="checkbox" name="overdue" value="1" {% if overdue == "1" %}checked{% endif %}>
      Overdue
    </label>

    <button class="btn" type="submit">Filter</button>
    <a class="btn" href="{% url 'inspections:list' %}">Reset</a>
  </form>

  <div class="actions">
    {% if can_manage_alerts %}
      <a class="btn warn" href="{% url 'inspections:alerts' %}">
        Alerts{% if open_alerts_count and open_alerts_count > 0 %} ({{ open_alerts_count }}){% endif %}
      </a>
    {% endif %}
    <a class="btn primary" href="{% url 'inspections:inspection_create' %}">
      {% if can_assign %}+ Assign Inspection{% else %}+ New Inspection{% endif %}
    </a>
  </div>
</div>

<div class="panel">
  {% if inspections %}
    <table>
      <thead>
        <tr>
          <th></th>
          <th>Date</th>
          <th>Vehicle</th>
          <th>Type</th>
          <th>Assigned</th>
          <th>Due</th>
          <th>Status / Result</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for i in inspections %}
          <tr>
            <td style="width:34px;">
              {% if i.alert and i.alert.status != "closed" %}
                <a class="alert-icon" href="{% url 'inspections:alert_update' i.alert.id %}" title="Open Alert"></a>
              {% else %}
                <span class="muted"> </span>
              {% endif %}
            </td>
            <td><strong>{{ i.inspection_date }}</strong></td>
            <td>
              <div><strong>{% if i.vehicle.unit_number %}Unit {{ i.vehicle.unit_number }}{% else %}Vehicle{% endif %}</strong></div>
              <div class="muted">{% if i.vehicle.year %}{{ i.vehicle.year }} {% endif %}{{ i.vehicle.make }} {{ i.vehicle.model }}</div>
              {% if i.vehicle.plate %}<div class="muted">Plate: {{ i.vehicle.plate }}</div>{% endif %}
            </td>
            <td>{{ i.inspection_type|default:"—" }}</td>
            <td>
              {% if i.assigned_to %}
                {{ i.assigned_to }}
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if i.due_date %}
                {% if i.status != "completed" and i.due_date < today %}
                  <span class="pill danger">{{ i.due_date }}</span>
                {% else %}
                  {{ i.due_date }}
                {% endif %}
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
            <td>
              <span class="pill">{{ i.get_status_display }}</span>
              &nbsp;
              <span class="pill {% if i.result == 'fail' %}danger{% endif %}">{{ i.get_result_display }}</span>
            </td>
            <td>
              <div class="actions">
                <a class="btn" href="{% url 'inspections:inspection_update' i.id %}">
                  {% if i.status == "completed" %}View{% else %}Open{% endif %}
                </a>
                {% if can_assign %}
                  <a class="btn" href="{% url 'inspections:inspection_delete' i.id %}">Delete</a>
                {% endif %}
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">No inspections yet.</p>
    <div class="actions">
      {% if can_manage_alerts %}
        <a class="btn warn" href="{% url 'inspections:alerts' %}">Alerts</a>
      {% endif %}
      <a class="btn primary" href="{% url 'inspections:inspection_create' %}">
        {% if can_assign %}+ Assign Inspection{% else %}+ New Inspection{% endif %}
      </a>
    </div>
  {% endif %}
</div>

{% endblock %}
