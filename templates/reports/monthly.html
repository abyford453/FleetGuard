{% extends "base.html" %}
{% block page_title %}Monthly Report{% endblock %}
{% block page_subtitle %}{{ start }} to {{ end }}{% endblock %}
{% block content %}

<style>
  .panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px;box-shadow:0 12px 34px rgba(0,0,0,.22);}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);text-decoration:none;white-space:nowrap;background:transparent;}
  .btn.primary{border-color:rgba(37,214,255,.35);background:rgba(37,214,255,.06);}
  .grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:12px;}
  .card{grid-column:span 4;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px;min-height:120px;text-decoration:none;display:flex;flex-direction:column;justify-content:space-between;}
  .k{font-size:12px;letter-spacing:.08em;text-transform:uppercase;opacity:.70;}
  .v{font-size:28px;font-weight:950;}
  .muted{opacity:.70;font-size:13px;}
  .charts{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:12px;}
  .chartbox{grid-column:span 6;}
  .chart-wrap{position:relative;height:320px;width:100%;overflow:hidden;}
  .chart-wrap canvas{position:absolute;inset:0;width:100% !important;height:100% !important;display:block;}
  @media (max-width:1100px){.card{grid-column:span 6;}.chartbox{grid-column:span 12;}}
  @media (max-width:700px){.card{grid-column:span 12;}}
</style>

<div class="panel" style="margin-bottom:12px;">
  <div class="row">
    <div>
      <div style="font-weight:950;font-size:18px;">Monthly Executive Report</div>
      <div class="muted">Range: {{ start }} → {{ end }}</div>
    </div>
    <div class="row" style="justify-content:flex-end;">
      <a class="btn primary" href="{% url 'reports:export_monthly_xlsx' %}?start={{ start }}&end={{ end }}">Download Excel</a>
      <a class="btn" href="{% url 'reports:index' %}">Back to Reports</a>
    </div>
  </div>
</div>

<div class="grid" style="margin-bottom:12px;">
  <div class="card">
    <div>
      <div class="k">Fuel Spend (This Range)</div>
      <div class="v">${{ fuel_spend|floatformat:2 }}</div>
    </div>
    <div class="muted">Previous range: ${{ prev_spend|floatformat:2 }} • Δ ${{ delta|floatformat:2 }}</div>
  </div>
</div>

<div class="charts">
  <div class="chartbox panel">
    <div style="font-weight:950;margin-bottom:10px;">Fuel Spend by Day</div>
    <div class="chart-wrap"><canvas id="dailyChart"></canvas></div>
  </div>

  <div class="chartbox panel">
    <div style="font-weight:950;margin-bottom:10px;">Alerts by Severity / Status</div>
    <div class="chart-wrap"><canvas id="sevChart"></canvas></div>
  </div>

  <div class="chartbox panel" style="grid-column:span 12;">
    <div style="font-weight:950;margin-bottom:10px;">Top Vehicles by Fuel Spend</div>
    <div class="chart-wrap" style="height:360px;"><canvas id="topChart"></canvas></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const dailyLabels = {{ daily_labels_json|safe }};
  const dailyValues = {{ daily_values_json|safe }};

  const topLabels = {{ top_labels_json|safe }};
  const topValues = {{ top_values_json|safe }};

  const sevLabels = {{ sev_labels_json|safe }};
  const sevValues = {{ sev_values_json|safe }};

  const base = { responsive:true, maintainAspectRatio:false, animation:false };

  new Chart(document.getElementById("dailyChart"), {
    type:"line",
    data:{ labels:dailyLabels, datasets:[{ label:"Spend ($)", data:dailyValues, tension:0.25 }]},
    options: base
  });

  new Chart(document.getElementById("sevChart"), {
    type:"pie",
    data:{ labels:sevLabels, datasets:[{ label:"Count", data:sevValues }]},
    options: base
  });

  new Chart(document.getElementById("topChart"), {
    type:"bar",
    data:{ labels:topLabels, datasets:[{ label:"Spend ($)", data:topValues }]},
    options:{ ...base, indexAxis:"y" }
  });
</script>

{% endblock %}
